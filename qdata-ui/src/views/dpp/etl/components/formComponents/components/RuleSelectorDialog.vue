<template>
    <el-dialog v-model="dialogVisible" draggable class="medium-dialog"
        :class="{ 'max-dialogs-status0': dialogStatus === 0 }" :title="dialogTitle" destroy-on-close
        :append-to="$refs['app-container']">
        <div class="content" v-if="dialogStatus == 0">
            <SideMenu :dialogStatus="dialogStatus" @card-click="handleCardClick" ref="SideMenus" :type="type" />
        </div>
        <div class="content" style="height: 600px; padding-right: 10px;" v-show="dialogStatus == 1 || dialogStatus == 2"
            :disabled="dialogStatus == 2">
            <el-form ref="formRef" :model="form" label-width="130px">
                <el-divider content-position="center">
                    <span class="blue-text">Âü∫Á°Ä‰ø°ÊÅØ</span>
                </el-divider>
                <el-row>
                    <el-col :span="8">
                        <el-form-item label="Ê∏ÖÊ¥óÂêçÁß∞" prop="name"
                            :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•Ê∏ÖÊ¥óÂêçÁß∞ÂêçÁß∞', trigger: 'blur' }]">
                            <el-input v-model="form.name" placeholder="ËØ∑ËæìÂÖ•Ê∏ÖÊ¥óÂêçÁß∞" :disabled="falg" />
                        </el-form-item>
                    </el-col>
                    <el-col :span="8">
                        <el-form-item label="Ê∏ÖÊ¥óËßÑÂàôÁºñÂè∑" prop="ruleCode">
                            <el-input v-model="form.ruleCode" placeholder="ËØ∑ËæìÂÖ•Ê∏ÖÊ¥óËßÑÂàôÁºñÂè∑" disabled />
                        </el-form-item>
                    </el-col>
                    <el-col :span="8">
                        <el-form-item label="Ê∏ÖÊ¥óËßÑÂàôÂêçÁß∞" prop="ruleName">
                            <el-input v-model="form.ruleName" placeholder="ËØ∑ËæìÂÖ•Ê∏ÖÊ¥óËßÑÂàôÂêçÁß∞" disabled />
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="8">
                        <el-form-item label="Áä∂ÊÄÅ" prop="status">
                            <el-radio-group v-model="form.status" :disabled="falg">
                                <el-radio :value="'1'">‰∏äÁ∫ø</el-radio>
                                <el-radio :value="'0'">‰∏ãÁ∫ø</el-radio>
                            </el-radio-group>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="24">
                        <el-form-item label="ËßÑÂàôÊèèËø∞" prop="ruleDesc">
                            <el-input type="textarea" v-model="form.ruleDesc" placeholder="ËØ∑ËæìÂÖ•ËßÑÂàôÊèèËø∞" :disabled="falg" />
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="24">
                        <el-form-item label="Where Êù°‰ª∂" prop="whereClause">
                            <el-input type="textarea" v-model="form.whereClause" placeholder="ËØ∑ËæìÂÖ• WHERE Êù°‰ª∂"
                                :disabled="falg" />
                        </el-form-item>
                    </el-col>
                </el-row>
                <!-- ËßÑÂàôÈÖçÁΩÆ -->
                <el-divider content-position="center">
                    <span class="blue-text">ËßÑÂàôÈÖçÁΩÆ</span>
                </el-divider>
                <el-row v-if="type != 3">
                    <el-col :span="24">
                        <el-form-item label="Ê∏ÖÊ¥óÂ≠óÊÆµ" prop="columns" :disabled="falg"
                            :rules="[{ required: true, message: 'ËØ∑ÈÄâÊã©Ê∏ÖÊ¥óÂ≠óÊÆµ', trigger: 'blur' }]">
                            <el-select v-if="isMultipleSelect" v-model="form.columns" placeholder="ËØ∑ÈÄâÊã©Ê∏ÖÊ¥óÂ≠óÊÆµ" multiple
                                clearable>
                                <el-option v-for="dict in processedFields" :key="dict.columnName" :label="dict.label"
                                    :value="dict.columnName" />
                            </el-select>
                            <!-- ÂçïÈÄâ -->
                            <el-select v-else v-model="form.columns" placeholder="ËØ∑ÈÄâÊã©Ê∏ÖÊ¥óÂ≠óÊÆµ" clearable>
                                <el-option v-for="dict in processedFields" :key="dict.columnName" :label="dict.label"
                                    :value="dict.columnName" :disabled="form?.ruleCode == '039' && !(
                                        dict.columnType?.toUpperCase().includes('DATE') ||
                                        dict.columnType?.toUpperCase().startsWith('TIMESTAMP') ||
                                        dict.columnType?.toUpperCase() === 'TIME' ||
                                        dict.columnType?.toUpperCase() === 'YEAR'
                                    )
                                        " />

                            </el-select>
                        </el-form-item>
                    </el-col>
                </el-row>
                <component :is="currentRuleComponent" ref="ruleComponentRef" :form="form.ruleConfig"
                    :inputFields="processedFields" :falg="falg" :columnList="columnList" />
            </el-form>
        </div>
        <template #footer>
            <template v-if="dialogStatus == 1"><el-button type="primary" @click="handleSave" v-if="!falg">Á°ÆÂÆö</el-button>
                <el-button @click="handleBack" v-if="!mode">ËøîÂõû</el-button>
                <!-- <el-button type="warning" @click="handleSpotCheck">È¢ÑËßà</el-button> -->
            </template>
            <el-button @click="closeDialog" v-else>ÂÖ≥Èó≠</el-button>
        </template>
    </el-dialog>
</template>

<script setup>
import SideMenu from "./SideMenu.vue";
// Êï∞ÂÄºËæπÁïåÂÄºË∞ÉÊï¥
import NumberRangeSelector from "./NumberRangeSelector.vue";
// Êûö‰∏æÂÄºÊò†Â∞ÑÊ†áÂáÜÂåñ
import EnumRule from "./EnumRule.vue";
// ÊåâÁªÑÂêàÂ≠óÊÆµÂéªÈáç
import FieldCombiner from "./FieldCombiner.vue";
// Â≠óÊÆµÂâçÁºÄ/ÂêéÁºÄÁªü‰∏Ä
import AffixEditor from "./AffixEditor.vue";
// Á´ô‰ΩçÁªÑ‰ª∂
import EmptyRule from "./EmptyRule.vue";
import moment from "moment";
let falg = ref(false)
const { proxy } = getCurrentInstance();
const { quality_warning_status, } =
    proxy.useDict(
        "quality_warning_status",
    );
const emit = defineEmits(["confirm"]);
// Áà∂ÁªÑ‰ª∂‰º†ÂÖ•ËØÑÊµãÂØπË±°ÂàóË°®
const props = defineProps({
    inputFields: {
        type: Array,
        default: () => [],
    },
    type: {
        type: String,
        default: ''
    },
});

const { inputFields } = toRefs(props);
const processedFields = computed(() => {
    return inputFields.value.map(item => ({
        ...item,
        label: item.columnComment
            ? `${item.columnName} / ${item.columnComment}`
            : item.columnName
    }))
})

const dialogVisible = ref(false);
const dialogStatus = ref(1);
const dialogTitle = ref("");
const formRef = ref();

let form = reactive({
    name: '',
    ruleName: "",//Ê∏ÖÊ¥óËßÑÂàôÂêçÁß∞Ôºö
    ruleCode: "",//Ê∏ÖÊ¥óËßÑÂàôÁºñÂè∑Ôºö
    status: "1",
    // warningLevel: "2",
    whereClause: "",
    columns: '',
    tableName: "",
    ruleDesc: "",
    type: '',
    ruleConfig: {
        //Êï∞ÂÄºËæπÁïåË∞ÉÊï¥
        max: '100',
        min: "0",
        handleType: "1",
        // ÂéªÈô§Â≠óÁ¨¶‰∏≤Á©∫Ê†º
        handleType: "1",//"1-ÂéªÈô§ÂâçÂêéÁ©∫Ê†ºÔºå2-ÂéªÈô§ÊâÄÊúâÁ©∫Ê†º"
        // Ê≠£ÂàôË°®ËææÂºèÊõøÊç¢
        pattern: "",//Ë°®ËææÂºè
        replacement: "",//replacement
        ruleValue: [],
        deduplicationStrategy: "1",
        dataRangeValue: moment().format("YYYY-MM-DD"),
        // Êï∞ÊçÆÊ∑ªÂä†ÂÄº
        stringValue: "",//Ê∑ªÂä†ÂÄº

    }
});
const isMultipleSelect = computed(() => {
    return form.ruleCode == '019' || form.ruleCode == '029';
})
let title = ref()

const ruleConfigMap = {
    // Êï∞ÂÄºËåÉÂõ¥
    "001": {
        label: "Êï∞ÂÄºËæπÁïåÂÄºË∞ÉÊï¥",
        component: NumberRangeSelector,
    },
    "019": {
        label: "ÁªÑÂêàÂ≠óÊÆµ‰∏∫Á©∫Âà†Èô§",
        component: EmptyRule,
    },
    "010": {
        label: "Â≠óÊÆµÂâçÁºÄ/ÂêéÁºÄÁªü‰∏Ä",
        component: AffixEditor,
    },
    "024": {
        label: "Êûö‰∏æÂÄºÊò†Â∞ÑÊ†áÂáÜÂåñ",
        component: EnumRule,
    },
    "029": {
        label: "ÊåâÁªÑÂêàÂ≠óÊÆµÂéªÈáç",
        component: FieldCombiner,
    },
};

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÂΩìÂâçËßÑÂàôÈÖçÁΩÆ
const currentRuleConfig = computed(() => {
    return ruleConfigMap[form.ruleCode] || null;
});

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÂΩìÂâçËßÑÂàôÁªÑ‰ª∂
const currentRuleComponent = computed(() => {
    return currentRuleConfig.value?.component || null;
});

let loading = ref(false);
let columnList = ref([]);

let ruleComponentRef = ref()
async function handleSave() {
    await nextTick();
    try {
        await formRef?.value?.validate();
    } catch (err) {
        proxy.$message.warning("ËØ∑ÂÆåÂñÑÂøÖÂ°´È°π");
        return;
    }
    let res = { valid: true, data: {} };
    res = await ruleComponentRef.value?.validate();
    if (!res.valid) return;
    if (!isMultipleSelect.value) {
        form.columns = [form.columns]

    }
    if (form.ruleCode == '035') {

    }
    const formCopy = JSON.parse(JSON.stringify({
        ...form,
        ruleConfig: JSON.stringify({
            columns: form.columns,
            ...res.data,
            parentName: form.parentName
        }),
    }));

    emit('confirm', formCopy, mode.value);
}
let sampleCheckMsg = ref()

function handleCardClick(data) {
    resetForm()
    form.ruleName = data?.name;
    form.ruleCode = data?.code;
    form.ruleType = data?.strategyKey;
    form.type = data?.type;
    form.parentName = data?.parentName;
    form.dimensionType = data?.qualityDim
    console.log("üöÄ ~ handleCardClick ~ data:", data)
    console.log("üöÄ ~ handleCardClick ~  form.dimensionType:", form.dimensionType)
    dialogTitle.value = `Êñ∞Â¢ûÊ∏ÖÊ¥óËßÑÂàô${data?.name ? '-' + data.name : ''}`
    dialogStatus.value = 1;
}
let mode = ref();
async function openDialog(record, index, fg) {
    falg.value = fg;
    mode.value = index;
    resetForm();
    dialogTitle.value = `${mode.value ? '‰øÆÊîπ' : 'Êñ∞Â¢û'}Ê∏ÖÊ¥óËßÑÂàô${record?.ruleName ? `-${record.ruleName}` : ''}`;
    if (falg?.value) {
        dialogTitle.value = `Ê∏ÖÊ¥óËßÑÂàô${record?.ruleName ? `-${record.ruleName}` : ''}`;
    }
    dialogStatus.value = mode.value ? 1 : 0;
    dialogVisible.value = true;

    if (index) {
        dialogStatus.value = 1;
        const { ruleType, ruleConfig, columns, ...rest } = record;
        Object.assign(form, rest);
        form.ruleType = ruleType;

        try {
            form.ruleConfig = typeof ruleConfig == 'string' ? JSON.parse(ruleConfig) : ruleConfig;
        } catch (e) {
            form.ruleConfig = {};
        }
        if (isMultipleSelect.value) {
            form.columns = Array.isArray(columns) ? columns : [];
        } else {
            form.columns = Array.isArray(columns) && columns.length > 0 ? columns[0] : '';
        }
    } else {
        resetForm();
    }
}

const initialForm = () => ({
    id: '',
    name: '',
    type: '',
    ruleName: "",//Ê∏ÖÊ¥óËßÑÂàôÂêçÁß∞Ôºö
    ruleCode: "",//Ê∏ÖÊ¥óËßÑÂàôÁºñÂè∑Ôºö
    status: "1",
    whereClause: "",
    columns: isMultipleSelect.value ? [] : '',
    tableName: "",
    ruleDesc: "",
    ruleConfig: {

        //Êï∞ÂÄºËæπÁïåË∞ÉÊï¥
        max: '100',
        min: "0",
        handleType: "1",
        // ÂéªÈô§Â≠óÁ¨¶‰∏≤Á©∫Ê†º
        handleType: "1",//"1-ÂéªÈô§ÂâçÂêéÁ©∫Ê†ºÔºå2-ÂéªÈô§ÊâÄÊúâÁ©∫Ê†º"
        // Ê≠£ÂàôË°®ËææÂºèÊõøÊç¢
        pattern: "",//Ë°®ËææÂºè
        replacement: "",//replacement

        ruleValue: [],
        deduplicationStrategy: "1",
        // Êûö‰∏æÂÄºÊò†Â∞ÑÊ†áÂáÜÂåñ
        stringValue: [],
        dataRange: "1",// 0ÔºöÂõ∫ÂÆöÊó∂Èó¥ËåÉÂõ¥Ôºå1ÔºöÂÖ∑‰ΩìÊó•Êúü
        dataRangeType: "1",// 0ÔºöÂ§©Ââç
        dataRangeValue: moment().format("YYYY-MM-DD"),
        handleType: "1",// 0ÔºöËøáÊúüÂ§ÑÁêÜÊñπÂºèÔºå1ÔºöÂà†Èô§ËÆ∞ÂΩï
        handleColumns: "",// // Ê†áËÆ∞Â≠óÊÆµ     ÈÄâ‰∏≠ËøáÊúüÂ§ÑÁêÜÊñπÂºèÊâç‰ºöÊúâ
        handleValue: "",// Ê†áËÆ∞ÂÄº       ÈÄâ‰∏≠ËøáÊúüÂ§ÑÁêÜÊñπÂºèÊâç‰ºöÊúâ

    }
});

function resetForm() {
    Object.assign(form, initialForm());
    columnList.value = [];
    title.value = ''
    sampleCheckMsg.value = ''
}

function closeDialog() {
    dialogVisible.value = false;
    resetForm();
}

function handleBack() {
    dialogStatus.value = 0;
    dialogTitle.value = `Êñ∞Â¢ûËØÑÊµãËßÑÂàô`
    resetForm()
}
defineExpose({ openDialog, closeDialog })
</script>

<style scoped>
.blue-text {
    color: var(--el-color-primary);
}

.medium-dialog {
    width: 800px;
}
</style>
<style>
.el-dialog.max-dialogs-status0 .el-dialog__body {
    padding: 0 !important;
    padding-left: 10px !important;
}
</style>